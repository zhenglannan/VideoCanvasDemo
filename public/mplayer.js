(()=>{"use strict";var t={327:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.WCtrl=void 0,e.WCtrl=class{constructor(t){this.video=t}open(t){if("MediaSource"in window&&MediaSource.isTypeSupported(t)){if(this.buff=new Array,this.ms=new MediaSource,this.ms.addEventListener("sourceopen",(()=>{this.sb||(this.sb=this.ms.addSourceBuffer(t),this.sb.mode="sequence",this.sb.addEventListener("updateend",(()=>{this.loadBuff()})))})),this.url=URL.createObjectURL(this.ms),this.video.src=this.url,this.video.pause){var e=this.video.play();e&&e.then((t=>{})).catch((t=>{}))}return!0}return console.error("Unsupported MIME type or codec: ",t),!1}close(){if(this.ms){if(this.sb){try{this.ms.removeSourceBuffer(this.sb)}catch(t){console.error(t.message)}this.sb=null}if("open"===this.ms.readyState)try{this.ms.endOfStream()}catch(t){console.error(t.message)}this.ms=null}this.video&&(this.video.pause(),this.video.src="",this.video.removeAttribute&&this.video.removeAttribute("src"),this.video.load()),this.url&&(URL.revokeObjectURL(this.url),this.url=null),this.buff&&(this.buff=null)}append(t){this.buff&&(this.buff.push(t),this.loadBuff())}loadBuff(){if(this.sb&&!this.sb.updating&&this.buff.length)try{this.sb.appendBuffer(this.buff.shift())}catch(t){}}}},521:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.WLoader=void 0;class s{open(t,e){return this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{},this.ws.onmessage=t=>{this.ws&&e(t.data)},console.log("wsopen:"+this.ws.url),!0}close(){this.ws&&(console.log("wsclose:"+this.ws.url),this.ws.close(),this.ws=null)}}class i{open(t,e){return this.fr=!0,this.cb=e,this.url=t,console.log("fhopen:"+this.url),fetch(t).then((t=>{if(this.fr){if(t.ok&&t.status>=200&&t.status<=299)return this.process(t.body.getReader());t.text().then((e=>{console.log("error:"+t.status+", "+t.statusText+", "+e)})).catch((t=>{console.log("text catch:"+t.code+", "+t.message)}))}})).catch((t=>{console.log("fhcatch:"+this.url+", "+t.message)})),!0}close(){this.fr&&(console.log("fhclose:"+this.url),this.fr=!1,this.cb=null,this.url=null)}process(t){return t.read().then((e=>{if(e.done)this.fr=!1;else{if(!this.fr||!this.cb)return t.cancel();this.cb(e.value.buffer),this.process(t)}})).catch((t=>{console.log("process catch:"+t.code+", "+t.message)}))}}e.WLoader=class{constructor(t,e){this.url=t,this.cb=e}open(){return this.close(),"http"==this.url.substr(0,4).toLowerCase()?this.ls=new i:this.ls=new s,this.ls.open(this.url,this.cb)}close(){this.ls&&(this.ls.close(),this.ls=null)}}},1:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.WRate=void 0,e.WRate=class{constructor(){this.date=new Date,this.length=0,this.rate=0}get value(){return this.rate}append(t){this.length+=t}cale(){let t=new Date;return this.rate=1e3*this.length/(t.getTime()-this.date.getTime()),this.date=t,this.length=0,this.rate}}}},e={};function s(i){var r=e[i];if(void 0!==r)return r.exports;var a=e[i]={exports:{}};return t[i](a,a.exports,s),a.exports}(()=>{const t=s(521),e=s(327),i=s(1);class r{constructor(t){this.video=t,this.uid=this.randomStr(16)}get dataRate(){return this.rateData?this.rateData.value:0}get frameRate(){return this.rateFrame?this.rateFrame.value:0}open(t,e,s,i){return this.video?(this.ip=t,this.port=e,this.id=s,this.videoFlag=i,this.play()):(this._debugFlag&&console.log("video is null"),!1)}close(){this.stop(),this.video&&(this.video.poster=null),this.ip="",this.port=0,this.ip="",this.videoFlag="",this.startTime=null,this.stopTime=null}ptz(t,e){let s={cmd:t,speed:e};r.queryJson(this.hsUrl("ptz",s))}stopPTZ(){this.ptz(r.PTZ_STOP)}preset(t,e){let s={cmd:t,index:e};r.queryJson(this.hsUrl("ptz",s))}capture(t,e){var s=document.createElement("canvas");return s.width=this.video.videoWidth,s.height=this.video.videoHeight,s.getContext("2d").drawImage(this.video,0,0,s.width,s.height),s.toDataURL(t,e)}openFile(t,e,s,i,r){return this.video?(this.ip=t,this.port=e,this.id=s,this.startTime=i,this.stopTime=r,this.play()):(this._debugFlag&&console.log("video is null"),!1)}get playPause(){return this.pauseFlag}set playPause(t){Boolean(this.pauseFlag)!=Boolean(t)&&(this.pauseFlag=t,this.playControlSet(this.pauseFlag?r.PLAYBACK_PAUSE:r.PLAYBACK_RESTART))}playFast(){this.playControlSet(r.PLAYBACK_FAST)}playSlow(){this.playControlSet(r.PLAYBACK_SLOW)}set httpFlag(t){this._httpFlag=t}set debugFlag(t){this._debugFlag=t}static set sslFlag(t){r._sslFlag=t}static getCameras(t,e,s){r.queryJson(r.getUrl("http",t,e,"dev_info",{}),s)}static find(t,e,s,i,a,h){let o={id:s,start:r.dateToStr(i),stop:r.dateToStr(a)};r.queryJson(r.getUrl("http",t,e,"record",o),((t,e)=>{if(h)if(t){var s=new Array;e.item.forEach((t=>{s.push({start:r.strToDate(t.start),stop:r.strToDate(t.stop),name:t.name,size:t.size})})),h(t,s)}else h(t,e)}))}static captureImage(t,e,s,i,a){let h={id:s};i&&(h.quality=i),r.queryBlob(r.getUrl("http",t,e,"real_image",h),a)}static quit(t,e){r.queryJson(r.getUrl("http",t,e,"system",{t:"quit"}))}static getUrl(t,e,s,i,a){let h=t;r._sslFlag&&(h+="s");let o="";for(var l in a)if(void 0!==a[l]){let t=`${l}=${a[l]}`;o?o+="&"+t:o="?"+t}return`${h}://${e}:${s}/${i}`+o}makeUrl(t,e,s){let i=s||{};return i.id=this.id,i.uid=this.uid,r.getUrl(t,this.ip,this.port,e,i)}hsUrl(t,e){return this.makeUrl("http",t,e)}wsUrl(t,e){return this.makeUrl("ws",t,e)}checkDelay(t){if(this.video.buffered.length){var e=1e3*(this.video.buffered.end(0)-this.video.currentTime);this._debugFlag&&console.log("def:"+e),e>r.LIMIT_DELAY&&(t&&e>3e4?(this._debugFlag&&console.log("error buffered:"+this.video.currentTime+","+this.video.buffered.end(0)),this.restart()):(this._debugFlag&&console.log("seek current:"+this.video.currentTime+","+this.video.buffered.end(0)),this.video.currentTime=this.video.buffered.end(0)))}}checkFreeze(){if(this.video.getVideoPlaybackQuality){let t=this.video.getVideoPlaybackQuality().totalVideoFrames.toString();t==this.checkFrame?(this._debugFlag&&console.log("frame freeze"),(new Date).getTime()-this.checkFrameTime>r.LIMIT_FREEZE&&this.restart()):(this._debugFlag&&console.log("frame move:"+t),this.checkFrame=t,this.checkFrameTime=(new Date).getTime())}else{let t=document.createElement("canvas");t.width=this.video.videoWidth,t.height=this.video.videoHeight,t.getContext("2d").drawImage(this.video,0,0,t.width,t.height);let e=t.toDataURL("image/png");this.checkFrame==e?(this._debugFlag&&console.log("image freeze"),(new Date).getTime()-this.checkFrameTime>r.LIMIT_FREEZE&&this.restart()):(this._debugFlag&&console.log("image move"),this.checkFrame=e,this.checkFrameTime=(new Date).getTime())}}setPlayState(t){this.playState!=t&&(this.playState&&(this.video.poster=this.capture("image/png")),this.playState=t,this.onstatechanged&&this.onstatechanged(this.playState))}play(){let s,a={m:"mp4"};this.startTime?(s="play",a.t=r.dateToStr(this.startTime),a.t2=r.dateToStr(this.stopTime)):(s="real",a.flag=this.videoFlag);var h=this._httpFlag?this.hsUrl(s,a):this.wsUrl(s,a);this.loader=new t.WLoader(h,(t=>{if(this.ctrl)this.ctrl.append(t);else{let s=new Uint8Array(t),i=s.indexOf(0),r=String.fromCharCode.apply(null,s.subarray(0,i));this._debugFlag&&console.log("open video mimetype:"+r),this.ctrl=new e.WCtrl(this.video),this.ctrl.open(r),this.ctrl.append(s.slice(i+1))}this.rateData&&this.rateData.append(t.byteLength)})),this.loader.open(),this.checkFrame=null,this.checkEvent=setInterval((()=>{if(this.checkEvent){if(this.video.hasOwnProperty("isConnected")&&!this.video.isConnected)return this._debugFlag&&console.log("video disconnected"),void this.stop(!1);if(!this.startTime)return this.checkDelay(!0),void this.checkFreeze();if(!this.pauseFlag){if(this.ontimechanged){let t=(new Date).getTime();t-this.getPosTime>=3e4&&(this.getPosTime=t,this.playControlGet(r.PLAYBACK_GETTIMEPOS,((t,e)=>{if(t){let t=r.strToDate(e.value);this.posTime!=t&&(this.posTime=t,this.ontimechanged(this.posTime))}})))}this.checkDelay(!1)}}}),5e3),this.video.onerror=t=>{this._debugFlag&&console.log("video error",t),this.restart()},this.playState=!1,this.pauseFlag=!1,this.video.oncanplay=t=>{this.setPlayState(!0)},this.rateData=new i.WRate,this.rateFrame=new i.WRate;var o=0;return this.rateEvent=setInterval((()=>{var t=this.rateData.cale();if(this.ondataratechanged&&this.ondataratechanged(t),this.video.getVideoPlaybackQuality){var e=this.video.getVideoPlaybackQuality().totalVideoFrames;this.rateFrame.append(e-o),o=e;var s=this.rateFrame.cale();this.onframeratechanged&&this.onframeratechanged(s)}}),1e3),!0}stop(t=!1){this.video.onerror=null,this.video.oncanplay=null,this.setPlayState(!1),this.checkEvent&&(clearInterval(this.checkEvent),this.checkEvent=0),this.loader&&(this.loader.close(),this.loader=null),this.ctrl&&(this.ctrl.close(),this.ctrl=null),this.rateEvent&&(clearInterval(this.rateEvent),this.rateEvent=0),this.rateData=null,this.rateFrame=null}restart(){this.stop(!0),this.play()}playControlSet(t,e){let s={cmd:t,value:e};r.queryJson(this.hsUrl("play_ctrl",s))}playControlGet(t,e){let s={cmd:t};r.queryJson(this.hsUrl("play_ctrl",s),e)}static queryJson(t,e=null){let s=new XMLHttpRequest;s.open("GET",t,!0),s.send(""),e&&(s.onreadystatechange=()=>{4==s.readyState&&(200==s.status?e(!0,JSON.parse(s.responseText)):e(!1,s.status+","+s.responseText))})}static queryBlob(t,e=null){let s=new XMLHttpRequest;s.responseType="blob",s.open("GET",t,!0),s.send(""),e&&(s.onreadystatechange=()=>{4==s.readyState&&(200==s.status?e(!0,s.response):e(!1,s.status+","+s.responseText))})}randomStr(t){let e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s="";for(let i=0;i<t;i++)s+=e[Math.floor(Math.random()*e.length)];return s}static strToDate(t){return new Date(+t.substr(0,4),+t.substr(4,2)-1,+t.substr(6,2),+t.substr(8,2),+t.substr(10,2),+t.substr(12,2))}static dateToStr(t){if(t)return(1e10*t.getFullYear()+1e8*(t.getMonth()+1)+1e6*t.getDate()+1e4*t.getHours()+100*t.getMinutes()+t.getSeconds()).toString()}}r.SPEED_MIN=1,r.SPEED_MAX=10,r.PRESET_GOTO=4609,r.PRESET_SET=4610,r.PRESET_CLEAR=4611,r.PTZ_STOP=768,r.PTZ_TOP=769,r.PTZ_BOTTOM=770,r.PTZ_LEFT=771,r.PTZ_RIGHT=772,r.PTZ_LEFT_TOP=1025,r.PTZ_LEFT_BOTTOM=1026,r.PTZ_RIGHT_TOP=1027,r.PTZ_RIGHT_BOTTOM=1028,r.PTZ_ZOOM_IN=1281,r.PTZ_ZOOM_OUT=1282,r.PTZ_ZOOM_IN_STOP=1283,r.PTZ_ZOOM_OUT_STOP=1284,r.PTZ_FOCUS_IN=1537,r.PTZ_FOCUS_OUT=1538,r.PTZ_FOCUS_IN_STOP=1539,r.PTZ_FOCUS_OUT_STOP=1540,r.PTZ_APERTURE_INCREASE=2305,r.PTZ_APERTURE_DECREASE=2306,r.PTZ_APERTURE_INCREASE_STOP=2307,r.PTZ_APERTURE_DECREASE_STOP=2308,r.PTZ_AUX_ON=2817,r.PTZ_AUX_OFF=2818,r.PTZ_LIGHT_ON=2821,r.PTZ_LIGHT_OFF=2822,r.LIMIT_DELAY=1500,r.LIMIT_FREEZE=1e4,r.PLAYBACK_PAUSE=3,r.PLAYBACK_RESTART=4,r.PLAYBACK_FAST=5,r.PLAYBACK_SLOW=6,r.PLAYBACK_GETTIMEPOS=13,window.MPlayer=r})()})();